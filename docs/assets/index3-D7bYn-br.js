import{d as K,r as X,s as Y,a as U,ap as W,f as Z,w as ee,o as te,b as le,c as D,p as G,i as z,aq as oe,ar as ne}from"./index-7xuu4s0q.js";import{i as J,v as se,P as ie,w as re}from"./index-BCrenVw1.js";const ae=`.${G}-preview > [data-line]`,F=(t,e)=>+getComputedStyle(t).getPropertyValue(e).replace("px",""),ge=(t,e)=>{const L=oe(()=>{t.removeEventListener("scroll",o),t.addEventListener("scroll",o),e.removeEventListener("scroll",o),e.addEventListener("scroll",o)},50),o=g=>{const h=t.clientHeight,k=e.clientHeight,r=t.scrollHeight,d=e.scrollHeight,c=(r-h)/(d-k);g.target===t?(e.removeEventListener("scroll",o),e.scrollTo({top:t.scrollTop/c}),L()):(t.removeEventListener("scroll",o),t.scrollTo({top:e.scrollTop*c}),L())};return[()=>{L().finally(()=>{t.dispatchEvent(new Event("scroll"))})},()=>{t.removeEventListener("scroll",o),e.removeEventListener("scroll",o)}]},he=(t,e,L)=>{const{view:o}=L,g=ne(),h=s=>o.lineBlockAt(o.state.doc.line(s+1).from).top,k=s=>o.lineBlockAt(o.state.doc.line(s+1).from).bottom;let r=[],d=[],c=[];const I=()=>{r=[],d=Array.from(e.querySelectorAll(ae)),c=d.map(a=>Number(a.dataset.line));const s=[...c],{lines:f}=o.state.doc;let i=s.shift()||0,l=s.shift()||f;for(let a=0;a<f;a++)a===l&&(i=a,l=s.shift()||f),r.push({start:i,end:l-1})},H=(s,f)=>{let i=1;for(let l=d.length-1;l-1>=0;l--){const a=d[l],T=d[l-1];if(a.offsetTop+a.offsetHeight>f&&T.offsetTop<f){i=Number(T.dataset.line);break}}for(let l=r.length-1;l>=0;l--){const a=k(r[l].end),T=h(r[l].start);if(a>s&&T<=s){i=i<r[l].start?i:r[l].start;break}}return i};let N=0,_=0;const n=()=>{var s,f,i;if(_!==0)return!1;N++;const{scrollDOM:l,contentHeight:a}=o;let T=F(e,"padding-top");const j=o.lineBlockAtHeight(l.scrollTop),{number:A}=o.state.doc.lineAt(j.from),O=r[A-1];if(!O)return!1;let R=1;const B=e.querySelector(`[data-line="${O.start}"]`)||((s=e.firstElementChild)==null?void 0:s.firstElementChild),v=e.querySelector(`[data-line="${O.end+1}"]`)||((f=e.lastElementChild)==null?void 0:f.lastElementChild),E=l.scrollHeight-l.clientHeight,b=e.scrollHeight-e.clientHeight;let S=h(O.start),x=k(O.end),w=B.offsetTop,M=v.offsetTop-w;S===0&&(w=0,B===v?(T=0,x=a-l.offsetHeight,M=b):M=v.offsetTop),R=(l.scrollTop-S)/(x-S);const P=v==((i=e.lastElementChild)==null?void 0:i.lastElementChild)?v.offsetTop+v.clientHeight:v.offsetTop;if(x>=E||P>b){const $=H(E,b);S=h($),R=(l.scrollTop-S)/(E-S);const y=e.querySelector(`[data-line="${$}"]`);S>0&&y&&(w=y.offsetTop),M=b-w+F(e,"padding-top")}const q=w-T+M*R;g(e,q,()=>{N--})},u=()=>{var s,f,i,l,a,T;if(N!==0)return;_++;const{scrollDOM:j}=o,A=e.scrollTop,O=e.scrollHeight,R=j.scrollHeight-j.clientHeight,B=e.scrollHeight-e.clientHeight;let v=(s=e.firstElementChild)==null?void 0:s.firstElementChild,E=(f=e.firstElementChild)==null?void 0:f.lastElementChild;if(c.length>0){let y=Math.ceil(c[c.length-1]*(A/O)),m=c.findLastIndex(C=>C<=y);m=m===-1?0:m,y=c[m];for(let C=m;C>=0&&C<c.length;)if(d[C].offsetTop>A){if(C-1>=0){C--;continue}y=-1,m=C;break}else{if(C+1<c.length&&d[C+1].offsetTop<A){C++;continue}y=c[C],m=C;break}switch(m){case-1:{v=(i=e.firstElementChild)==null?void 0:i.firstElementChild,E=d[m];break}case c.length-1:{v=d[m],E=(l=e.firstElementChild)==null?void 0:l.lastElementChild;break}default:v=d[m],E=d[m+1===d.length?m:m+1]}}let b=v===((a=e.firstElementChild)==null?void 0:a.firstElementChild)?0:v.offsetTop-F(v,"margin-top"),S=E.offsetTop,x=0;const{start:w,end:M}=r[Number(v.dataset.line||0)];let P=h(w);const q=h(M+1===o.state.doc.lines?M:M+1);let $=0;if(q>R||E.offsetTop+E.offsetHeight>B){const y=H(R,B),m=e.querySelector(`[data-line="${y}"]`);b=m?m.offsetTop-F(m,"margin-top"):b,P=h(y),x=(A-b)/(B-b),$=R-P}else v===((T=e.firstElementChild)==null?void 0:T.firstElementChild)?(v===E&&(S=E.offsetTop+E.offsetHeight+ +getComputedStyle(E).marginBottom.replace("px","")),$=q,x=Math.max(A/S,0)):(x=Math.max((A-b)/(S-b),0),$=q-P);g(t,P+$*x,()=>{_--})},p=s=>{var f;const{scrollDOM:i,contentHeight:l}=o,a=i.clientHeight;if(l<=a||e.firstElementChild.clientHeight<=e.clientHeight||o.state.doc.lines<=((f=r[r.length-1])==null?void 0:f.end))return!1;s.target===t?n():u()};return[()=>{I(),t.addEventListener("scroll",p),e.addEventListener("scroll",p),t.dispatchEvent(new Event("scroll"))},()=>{t.removeEventListener("scroll",p),e.removeEventListener("scroll",p)}]},ce={tocItem:{type:Object,default:()=>({})},mdHeadingId:{type:Function,default:()=>{}},onClick:{type:Function,default:()=>{}},scrollElementOffsetTop:{type:Number,default:0}},Q=K({props:ce,setup(t){const e=z("scrollElementRef"),L=z("roorNodeRef");return()=>{const{tocItem:o,mdHeadingId:g,onClick:h,scrollElementOffsetTop:k}=t;return D("div",{class:[`${G}-catalog-link`,o.active&&`${G}-catalog-active`],onClick:r=>{h(r,o),r.stopPropagation();const d=g(o.text,o.level,o.index),c=L.value.getElementById(d),I=e.value;if(c&&I){let H=c.offsetParent,N=c.offsetTop;if(I.contains(H))for(;H&&I!=H;)N+=H==null?void 0:H.offsetTop,H=H==null?void 0:H.offsetParent;const _=c.previousElementSibling;let n=0;_||(n=F(c,"margin-top")),I==null||I.scrollTo({top:N-k-n,behavior:"smooth"})}}},[D("span",{title:o.text},[o.text]),D("div",{class:`${G}-catalog-wrapper`},[o.children&&o.children.map(r=>D(Q,{mdHeadingId:g,key:`${o.text}-link-${r.level}-${r.text}`,tocItem:r,onClick:h,scrollElementOffsetTop:k},null))])])}}}),de=Q,fe={editorId:{type:String},class:{type:String,default:""},mdHeadingId:{type:Function,default:t=>t},scrollElement:{type:[String,Object]},theme:{type:String,default:"light"},offsetTop:{type:Number,default:20},scrollElementOffsetTop:{type:Number,default:0},onClick:{type:Function},onActive:{type:Function},isScrollElementInShadow:{type:Boolean,default:!1}},V=K({name:"MdCatalog",props:fe,emits:["onClick","onActive"],setup(t,e){const L=t.editorId,o=`#${L}-preview-wrapper`,g=X({list:[],show:!1,scrollElement:t.scrollElement||o}),h=Y(),k=U(),r=U(),d=U(),c=U();W("scrollElementRef",r),W("roorNodeRef",c);const I=Z(()=>{const n=[];return g.list.forEach((u,p)=>{const{text:s,level:f}=u,i={level:f,text:s,index:p+1,active:h.value===u};if(n.length===0)n.push(i);else{let l=n[n.length-1];if(i.level>l.level)for(let a=l.level+1;a<=6;a++){const{children:T}=l;if(!T){l.children=[i];break}if(l=T[T.length-1],i.level<=l.level){T.push(i);break}}else n.push(i)}}),n}),H=()=>{var n;if(g.scrollElement instanceof HTMLElement)return g.scrollElement;let u=document;return(g.scrollElement===o||t.isScrollElementInShadow)&&(u=(n=k.value)==null?void 0:n.getRootNode()),u.querySelector(g.scrollElement)},N=n=>{if(n.length===0)return g.list=[],!1;const{activeHead:u}=n.reduce((p,s,f)=>{var i;const l=(i=c.value)==null?void 0:i.getElementById(t.mdHeadingId(s.text,s.level,f+1));if(l instanceof HTMLElement){const a=re(l,r.value);if(a<t.offsetTop&&a>p.minTop)return{activeHead:s,minTop:a}}return p},{activeHead:n[0],minTop:Number.MIN_SAFE_INTEGER});h.value=u,g.list=n},_=()=>{N(g.list)};return ee(()=>h.value,n=>{const u=n?{...n}:void 0;t.onActive?t.onActive(u):e.emit("onActive",u)}),te(()=>{c.value=k.value.getRootNode();let n=H();r.value=n,J.on(L,{name:se,callback:u=>{var p,s;n=H(),r.value=n,d.value=n===document.documentElement?document:n,(p=d.value)==null||p.removeEventListener("scroll",_),N(u),(s=d.value)==null||s.addEventListener("scroll",_)}}),J.emit(L,ie)}),le(()=>{var n;(n=d.value)==null||n.removeEventListener("scroll",_)}),()=>D("div",{class:[`${G}-catalog${t.theme==="dark"?"-dark":""}`,`${t.class}`],ref:k},[I.value.map(n=>D(de,{mdHeadingId:t.mdHeadingId,tocItem:n,key:`link-${n.level}-${n.text}`,onClick:(u,p)=>{t.onClick?t.onClick(u,p):e.emit("onClick",u,p)},scrollElementOffsetTop:t.scrollElementOffsetTop},null))])}});V.install=t=>(t.component(V.name,V),t);export{V as M,ge as a,he as s};
